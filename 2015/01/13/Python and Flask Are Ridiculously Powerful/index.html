<!DOCTYPE HTML>
<html>
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>Python and Flask Are Ridiculously Powerful | 阿毛的博客</title>
    <meta name="author" content="Amao Zhao">
    
    <meta name="description" content="As a developer, I sometimes forget the power I wield. It’s easy to forget that, when something doesn’t work the way I’d like, I have the power to change it. Yesterday, I was reminded of this fact as I finally got fed up with the way payments are processed for my book. After being unhappy with the three different digital-goods payment processors I’ve used since the book came out, I took two hours and wrote my own solution using Python and Flask. That’s right. Two hours. It’s now powering my book payment processing and the flow is so incredibly simple that you can buy the book and begin reading it in 20 seconds.
Read on to find out how I created my own digital goods payment solution in an evening.">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="Python and Flask Are Ridiculously Powerful"/>
    <meta property="og:site_name" content="AmaoZhao"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="AmaoZhao" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">AmaoZhao</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            读书
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="https://avatars0.githubusercontent.com/u/398331?v=3&amp;s=466" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">赵少君</p>
                        <p class="desc">Python/Angular/Machine Learning</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    读书
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/总结/">
                    总结 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/编辑器/">
                    编辑器 <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Angular/">
                    Angular <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/机器学习/">
                    机器学习 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/机器学习/算法/">
                    算法 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Django/">
                    Django <span class="right">4 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Python/">
                    Python <span class="right">7 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Javascript/">
                    Javascript <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/SQLalchemy/">
                    SQLalchemy <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/面试/">
                    面试 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/API/">
                    API <span class="right">1 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/Python/">Python</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>Python and Flask Are Ridiculously Powerful</h1>
    


            </div>
            <time class="pink-link-context" datetime="2015-01-13T06:03:40.000Z"><a href="/2015/01/13/Python and Flask Are Ridiculously Powerful/">2015-01-13</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/Python/" class="chip pink lighten-1">Python</a>
        
    </div>


            <div class="toc pink-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#Payment-Processor-Purchase-Problems"><span class="section table-of-contents-text">Payment Processor Purchase Problems</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#Oh-Yeah-I’m-a-Programmer"><span class="section table-of-contents-text">Oh Yeah, I’m a Programmer</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#OK-Now-Give-Me-The-Book"><span class="section table-of-contents-text">OK, Now Give Me The Book</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#With-Great-Power-Comes…-Moar-Power"><span class="section table-of-contents-text">With Great Power Comes… Moar Power!</span></a></li></ol>
</div>


            <div class="entry pink-link-context">
                <p>As a developer, I sometimes forget the power I wield. It’s easy to forget that, when something doesn’t work the way I’d like, I have the power to change it. Yesterday, I was reminded of this fact as I finally got fed up with the way payments are processed for my book. After being unhappy with the three different digital-goods payment processors I’ve used since the book came out, I took two hours and wrote my own solution using Python and Flask. That’s right. Two hours. It’s now powering my book payment processing and the flow is so incredibly simple that you can buy the book and begin reading it in 20 seconds.</p>
<p>Read on to find out how I created my own digital goods payment solution in an evening.</p>
<a id="more"></a>
<h2 id="Payment-Processor-Purchase-Problems"><a href="#Payment-Processor-Purchase-Problems" class="headerlink" title="Payment Processor Purchase Problems"></a>Payment Processor Purchase Problems</h2><p>When I began selling the book, I used a combination of two services (one for credit cards and another for PayPal). Eventually, I found a single processor capable of supporting both. I’ve never been happy, though, with any of them. The most recent processor required users to create an account on the merchant’s system and enter their mailing address (though there was no use for it).</p>
<p>Additionally, I’ve had a terrible time trying to get Google Analytics to properly track visitor flow through the entire visit, including the checkout process. I always sensed that, if I were able to get that working and run A/B tests on my book page, I could greatly increase sales. Without proper tracking however, I was out of luck.</p>
<p>Lastly, sending out book updates is terribly time-consuming using three different processors. None supported updates well, and I wanted a one-click solution to sending out book updates. Finding a service that supported that was basically impossible.</p>
<h2 id="Oh-Yeah-I’m-a-Programmer"><a href="#Oh-Yeah-I’m-a-Programmer" class="headerlink" title="Oh Yeah, I’m a Programmer"></a>Oh Yeah, I’m a Programmer</h2><p>After receiving an email from a customer yesterday about how difficult the payment process was and informing me that I’m likely losing sales because of it, I got fed up. I decided to roll my own digital goods management solution. It needed the following work-flow:</p>
<blockquote>
<pre><code>When a customer clicks the &quot;Buy Now&quot; button, they should be asked to enter only their email address and credit card info, click &quot;Confirm&quot;, and be taken to a unique URL to download the book (generated specifically for that purchase). An email should be sent to the customer containing the generated URL (in case the customer needs to re-download the book). There should be a limit to the number of times (5) they can download it. The purchase and customer information should be stored in a database, and sending out updates should be a one-command affair.
</code></pre></blockquote>
<p>Clearly, it’s not that complicated. The trickiest part would be dynamically generating a unique URL that linked to the proper version of the book. Everything else seemed straightforward.<br>“Flask to the Rescue,” or “A Digital Goods Payment Solution in 100 Lines of Code”</p>
<p>Spoiler alert: the resulting application is exactly 100 lines of code. Flask is a great choice for a web application of this size. It doesn’t require a ton of boilerplate (cough like Django cough) but has good plugin support. Bottle would have been another fine choice, but I’ve used Flask more recently, so that’s what I chose.</p>
<p>To begin, I needed to decide how I was going to store the customer and purchase information. I decided to use <a href="http://www.sqlalchemy.org/" target="_blank" rel="external">SQLAlchemy</a>, since I’ve got a lot of experience with it because of <a href="http://www.sandman.io/" target="_blank" rel="external">sandman</a>. Flask has a plugin, Flask-SQLAlchemy, that makes using the two together easy. Since I don’t need anything too fancy database-wise, I chose SQLite as my database back-end.</p>
<p>Having made these decisions, I created a file named app.py and created the following models:<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(db.Model)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'product'</span></div><div class="line">    id = db.Column(db.Integer, primary_key=<span class="keyword">True</span>)</div><div class="line">    name = db.Column(db.String)</div><div class="line">    file_name = db.Column(db.String)</div><div class="line">    version = db.Column(db.String)</div><div class="line">    is_active = db.Column(db.Boolean, default=<span class="keyword">True</span>)</div><div class="line">    price = db.Column(db.Float)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Purchase</span><span class="params">(db.Model)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'purchase'</span></div><div class="line">    uuid = db.Column(db.String, primary_key=<span class="keyword">True</span>)</div><div class="line">    email = db.Column(db.String)</div><div class="line">    product_id = db.Column(db.Integer, db.ForeignKey(<span class="string">'product.id'</span>))</div><div class="line">    product = db.relationship(Product)</div><div class="line">    downloads_left = db.Column(db.Integer, default=<span class="number">5</span>)</div></pre></td></tr></table></figure></p>
<p>After adding the five different versions of the book to the database (I created a populate_db.py file and added them as SQLAlchemy models), I needed to decide how I was going to actually process payments. Luckily, Stripe makes accepting credit card payments stupidly easy, and I already had an account with them. Their “checkout.js” solution creates a form and button on your page. When the button is clicked, a simple and attractive payment overlay is displayed.</p>
<p><img src="http://www.jeffknupp.com/images/payment.jpg" alt=""></p>
<p>The action attribute of the form points to the page on your site that the user should be taken to after a successful payment. I added 5 of these buttons to my book sales site and added another hidden form field to contain the product_id (an integer between 1 and 5) of the product that was purchased.<br><strong>Processing Payments</strong></p>
<p>Clearly, I needed an endpoint in my application to process a successfully charged card. I added the following function to do so:<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">@app.route('/buy', methods=['POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">()</span>:</span></div><div class="line">    stripe_token = request.form[<span class="string">'stripeToken'</span>]</div><div class="line">    email = request.form[<span class="string">'stripeEmail'</span>]</div><div class="line">    product_id = request.form[<span class="string">'product_id'</span>]</div><div class="line">    product = Product.query.get(product_id)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        charge = stripe.Charge.create(</div><div class="line">                amount=int(product.price * <span class="number">100</span>),</div><div class="line">                currency=<span class="string">'usd'</span>,</div><div class="line">                card=stripe_token,</div><div class="line">                description=email)</div><div class="line">    <span class="keyword">except</span> stripe.CardError, e:</div><div class="line">        <span class="keyword">return</span> <span class="string">"""&lt;html&gt;&lt;body&gt;&lt;h1&gt;Card Declined&lt;/h1&gt;&lt;p&gt;Your chard could not</span></div><div class="line">        be charged. Please check the number and/or contact your credit card</div><div class="line">        company.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"""</div><div class="line">    <span class="keyword">print</span> charge</div><div class="line">    purchase = Purchase(uuid=str(uuid.uuid4()),</div><div class="line">            email=email,</div><div class="line">            product=product)</div><div class="line">    db.session.add(purchase)</div><div class="line">    db.session.commit()</div><div class="line">    message = Message(</div><div class="line">            subject=<span class="string">'Thanks for your purchase!'</span>,</div><div class="line">        sender=<span class="string">"jeff@jeffknupp.com"</span>,</div><div class="line">        html=<span class="string">"""&lt;html&gt;&lt;body&gt;&lt;h1&gt;Thanks for buying Writing Idiomatic Python!&lt;/h1&gt;</span></div><div class="line">&lt;p&gt;If you didn't already download your copy, you can visit</div><div class="line">&lt;a href="http://buy.jeffknupp.com/&#123;&#125;"&gt;your private link&lt;/a&gt;. You'll be able to</div><div class="line">download the file up to five times, at which point the link will</div><div class="line">expire.""".format(purchase.uuid),</div><div class="line">        recipients=[email])</div><div class="line">    <span class="keyword">with</span> mail.connect() <span class="keyword">as</span> conn:</div><div class="line">        conn.send(message)</div><div class="line">    <span class="keyword">return</span> redirect(<span class="string">'/&#123;&#125;'</span>.format(purchase.uuid))</div></pre></td></tr></table></figure></p>
<p>As you can see, I took a few shortcuts with the code (since I was coding angrily…). First, I have inline HTML to be returned from an unsuccessful charge and for the email that is sent upon purchase. That should be extracted to a global variable or, better, contained in a separate file. Second, I didn’t do any error checking when creating the Purchase object. But really, the only thing that could go wrong is trying to insert a duplicate uuid, which doesn’t concern me due to the probability of it happening (read: vanishingly small).</p>
<p>You can see I’m using a mail object. This comes from the Flask-Mail package, which makes sending email painless. I simply set it up to use GMail as the mail server and everything Just Worked.</p>
<h2 id="OK-Now-Give-Me-The-Book"><a href="#OK-Now-Give-Me-The-Book" class="headerlink" title="OK, Now Give Me The Book"></a>OK, Now Give Me The Book</h2><p>Now that I had the payment portion sorted out, I needed to add an endpoint for initiating downloads after a purchase. Since I’m using UUIDs as a primary key, I can also use them as the URL for the download endpoint. When someone hits the endpoint, I simply need to check that the UUID contained in the URL matches the UUID of a purchase in the database. If it does, serve the book file and decrement the downloads_left attribute. If not, return a 404 error. Here’s the code I came up with:<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">@app.route('/&lt;uuid&gt;')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_file</span><span class="params">(uuid)</span>:</span></div><div class="line">    purchase = Purchase.query.get(uuid)</div><div class="line">    <span class="keyword">if</span> purchase:</div><div class="line">        <span class="keyword">if</span> purchase.downloads_left &lt;= <span class="number">0</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">"""&lt;html&gt;&lt;body&gt;&lt;h1&gt;No downloads left!&lt;/h1&gt;&lt;p&gt;You have</span></div><div class="line">            exceeded the allowed number of downloads for this file. Please email</div><div class="line">            jeff@jeffknupp.com with any questions.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"""</div><div class="line">        purchase.downloads_left -= <span class="number">1</span></div><div class="line">        db.session.commit()</div><div class="line">        <span class="keyword">return</span> send_from_directory(directory=<span class="string">'files'</span>,</div><div class="line">                filename=purchase.product.file_name, as_attachment=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        abort(<span class="number">404</span>)</div></pre></td></tr></table></figure></p>
<p>Very straightforward. Using the UUID as a URL variable, search for a purchase. If it exists, just check that there are still downloads left and serve the file attribute of the purchase’s product. Otherwise, here’s a 404 for you.</p>
<p>Lastly, I needed to add a test endpoint that would allow me to simulate the purchase process. Here’s the code for that endpoint and the portion that runs the app:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">@app.route('/test')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"""&lt;http&gt;&lt;body&gt;&lt;form action="buy" method="POST"&gt;</span></div><div class="line">&lt;script</div><div class="line">    src="https://checkout.stripe.com/checkout.js" class="stripe-button"</div><div class="line">    data-key="pk_test_w3qNBkDR8A4jkKejBmsMdH34"</div><div class="line">    data-amount="999"</div><div class="line">    data-name="jeffknupp.com"</div><div class="line">    data-description="Writing Idiomatic Python 3 PDF ($9.99)"&gt;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;input type="hidden" name="product_id" value="2" /&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line">"""</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    sys.exit(app.run(debug=<span class="keyword">True</span>))</div></pre></td></tr></table></figure>
<h2 id="With-Great-Power-Comes…-Moar-Power"><a href="#With-Great-Power-Comes…-Moar-Power" class="headerlink" title="With Great Power Comes… Moar Power!"></a>With Great Power Comes… Moar Power!</h2><p>I was actually surprised at how quickly and easily I got this working. The entire application is a single file containing 100 lines of code. And it replaces a very important service I use everyday, one with which I’ve never been happy. Finally, I can track purchases without issue, which I’m convinced will increase sales.</p>
<p>It’s nice to be reminded that, as developers, we have a lot of power to shape our interactions with the digital world. I, for one, often forget that if I don’t like the way some piece of technology works, I can change it. From automating mechanical tasks like data entry to automatically sorting and organizing email, developers have the power to simplify their everyday tasks.</p>
<p>Having libraries like Flask in your tool belt is crucial to solving these sorts of problems, though. As you progress as a developer, you should be building up a set of tools that work for “core” problem domains. Flask is a perfect example, since needing to throw together a web app is a common problem.</p>
<p>And of course, sharing what you made is critical as well. I would be remiss if I created something useful for myself and didn’t share it with others. “Sharing” means more than “putting in a public GitHub repo”. You also need to let people know about it. From mailing lists to forums to personal blogs, there’s no shortage of avenues for making others aware of what you’ve created. I always try to give back to the community, since I’ve gained so much from it.</p>

                
<p class="pink-link-context">
    <a href="/2015/01/15/一切都是属性(python)/" rel="next" title="一切都是属性(python)">
    上一篇：一切都是属性(python)
  </a>
</p>



<p class="pink-link-context">
    <a href="/2015/01/13/A Better Way to Learn AngularJS/" rel="next" title="A Better Way to Learn AngularJS">
    下一篇：A Better Way to Learn AngularJS
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1"  data-activates="main-menu" title="menu"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo darken-1">
    
    <div class="container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="http://weibo.com/amaozhao" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/amaozhao" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                <div class="site-visitors-container white-text">
                    <span>
                        <i class="fa fa-user"></i>
                        <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
                    </span>
                    <span>&nbsp;|&nbsp;</span>
                    <span>
                        <i class="fa fa-eye"></i>
                        <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
                    </span>
                </div>
            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="https://github.com/amaozhao" target="_blank">Github地址</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright pink-link-context">
        <div class="container">
            © 2016 example.com, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('.menu-reading').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("TeX-AMS-MML_HTMLorMML");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



</body>
</html>
